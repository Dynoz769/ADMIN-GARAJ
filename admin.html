<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Garaj</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>Admin Dashboard - Pengurusan Garaj</header>
    <div class="container">
        <section class="hero">
            <div>
                <p class="eyebrow">Kontrol garaj sepintas lalu</p>
                <h1>Jejak status garaj secara real-time</h1>
                <p class="lede">Pilih zon untuk melihat 22 lot setiap satu. Semua tempahan aktif akan terus dipaparkan dengan butiran penyewa dan warna merah automatik.</p>
            </div>
            <div class="hero-actions">
                <button onclick="exportCSV()">Export CSV</button>
                <button class="danger" onclick="deleteAllData()">Padam Semua Data</button>
                <button class="logout" onclick="logout()">Logout</button>
            </div>
      </section>

        <div class="stats" id="statsBar"></div>

        <h3>Status Garaj</h3>
        <div class="board-controls">
          <div class="legend">
            <span class="legend-pill occupied-pill">Penuh</span>
            <span class="legend-pill available-pill">Kosong</span>
          </div>
          <div class="control-actions">
            <label class="toggle">
              <input type="checkbox" id="autoRefresh" checked>
              <span>Auto refresh 20s</span>
            </label>
            <button class="ghost" onclick="fetchGarajStatus(true)">Refresh</button>
            <span class="timestamp" id="lastUpdated">Kemaskini: -</span>
          </div>
        </div>
        <div class="garaj-container" id="garajContainer"></div>
    </div>

<script>
    const api = "https://admin-garaj-1.onrender.com";
    const totalGaraj = 88;
    const garajPerZone = 22;
    const zones = ['A','B','C','D'];

    function getGarageZone(garaj){
        if (garaj <= garajPerZone) return 'A';
        if (garaj <= garajPerZone * 2) return 'B';
        if (garaj <= garajPerZone * 3) return 'C';
        return 'D';
    }

    function formatGarageLabel(garaj){
        const zone = getGarageZone(garaj);
        const offset = garaj - ((zone.charCodeAt(0) - 65) * garajPerZone);
        return `${zone}${String(offset).padStart(2,'0')}`;
    }

    function groupGarajByZone(statusList){
        const parseGarajNumber = (g) => {
            if (g && Number.isFinite(g.garaj)) return g.garaj;
            if (g?.label && typeof g.label === 'string') {
                const match = g.label.match(/([A-D])(\d{1,2})/i);
                if (match) {
                    const zoneLetter = match[1].toUpperCase();
                    const offset = parseInt(match[2], 10);
                    if (!isNaN(offset)) {
                        return (zoneLetter.charCodeAt(0) - 65) * garajPerZone + offset;
                    }
                }
            }
            return null;
        };

        const grouped = (Array.isArray(statusList) ? statusList : []).reduce((acc, g) => {
            const garajNumber = parseGarajNumber(g);
            if (!garajNumber) return acc;

            const zone = g.zone || getGarageZone(garajNumber);
            if (!zone) return acc;

            if (!acc[zone]) acc[zone] = [];
            acc[zone].push({ ...g, garaj: garajNumber, label: g.label || formatGarageLabel(garajNumber), zone });
            return acc;
        }, {});

        zones.forEach(zoneKey => {
            if (!grouped[zoneKey]) grouped[zoneKey] = [];
            grouped[zoneKey].sort((a, b) => a.garaj - b.garaj);
        });

        return grouped;
    }

    function renderStats(statusList){
        const occupied = statusList.filter(s => s.occupied).length;
        const available = totalGaraj - occupied;
        const statsBar = document.getElementById('statsBar');
        statsBar.innerHTML = `
          <div class="stat-card">
            <p>Garaj Aktif</p>
            <h2>${occupied}</h2>
            <span class="pill danger-pill">Merah</span>
          </div>
          <div class="stat-card">
            <p>Garaj Kosong</p>
            <h2>${available}</h2>
            <span class="pill success-pill">Hijau</span>
          </div>
          <div class="stat-card">
            <p>Total Zon</p>
            <h2>${zones.length}</h2>
            <span class="pill">A - D</span>
          </div>
        `;
    }

    let refreshTimer = null;

    // Semak Autentikasi Admin
    document.addEventListener('DOMContentLoaded', () => {
        const role = localStorage.getItem('role');
        if (role !== 'admin') {
            alert('Akses ditolak.');
            window.location.href = 'login.html';
        }
        const toggle = document.getElementById('autoRefresh');
        toggle.addEventListener('change', (e) => setAutoRefresh(e.target.checked));
        setAutoRefresh(true);
        fetchGarajStatus();
    });

    function logout() {
        localStorage.removeItem('username');
        localStorage.removeItem('role');
        window.location.href = 'login.html';
    }

    // Padam semua data tempahan
    async function deleteAllData(){
      if(!confirm('Adakah anda pasti mahu memadam SEMUA tempahan? Tindakan ini tidak boleh diundur.')) return;

      try {
        const res = await fetch(`${api}/bookings`, { method: 'DELETE' });
        const data = await res.json();
        alert(data.message || 'Semua data berjaya dipadam.');
      } catch (error) {
        alert('Gagal memadam semua data. Sila cuba lagi.');
      }

      fetchGarajStatus();
    }

    // ===== GARAGE STATUS VISUALS =====
    function setAutoRefresh(enabled){
      if(refreshTimer) clearInterval(refreshTimer);
      if(enabled){
        refreshTimer = setInterval(() => fetchGarajStatus(), 20000);
      }
    }

    async function fetchGarajStatus(isManual=false){
      const res = await fetch(`${api}/garaj-status`);
      const status = await res.json();
      renderStats(status);
      const container = document.getElementById('garajContainer');
      container.innerHTML='';

      const timestamp = document.getElementById('lastUpdated');
      if(timestamp){
        const now = new Date();
        timestamp.textContent = `Kemaskini: ${now.toLocaleTimeString('ms-MY')}${isManual ? ' (Manual)' : ''}`;
      }

      const grouped = groupGarajByZone(status);
      let activeZone = container.dataset.activeZone || zones[0];
      if(!zones.includes(activeZone)) activeZone = zones[0];
      container.dataset.activeZone = activeZone;

      const zoneNav = document.createElement('div');
      zoneNav.className = 'zone-nav';

      zones.forEach(zone => {
        const btn = document.createElement('button');
        btn.className = `zone-pill ${activeZone === zone ? 'active' : ''}`;
        btn.textContent = `Zone ${zone}`;
        btn.onclick = () => {
          container.dataset.activeZone = zone;
          renderZone(zone, grouped, contentWrapper);
          [...zoneNav.children].forEach(child => child.classList.toggle('active', child.textContent === `Zone ${zone}`));
        };
        zoneNav.appendChild(btn);
      });

      const contentWrapper = document.createElement('div');
      renderZone(activeZone, grouped, contentWrapper);

      container.appendChild(zoneNav);
      container.appendChild(contentWrapper);
    }

    function renderZone(zone, grouped, target){
      const zoneData = grouped[zone] || [];
      target.innerHTML = '';

      const section = document.createElement('div');
      section.className = 'zone-section';

      const title = document.createElement('div');
      title.className = 'zone-header';
      const occupiedCount = zoneData.filter(g => g.occupied).length;
      const availableCount = garajPerZone - occupiedCount;
      title.innerHTML = `<div><p class="eyebrow">${occupiedCount} penuh Â· ${availableCount} kosong</p><h4>Zone ${zone} - ${garajPerZone} Garaj</h4></div>`;
      section.appendChild(title);

      const grid = document.createElement('div');
      grid.className = 'garaj-grid';

      if(zoneData.length === 0){
        const empty = document.createElement('div');
        empty.className = 'empty-zone';
        empty.textContent = 'Tiada data garaj untuk zon ini.';
        section.appendChild(empty);
        target.appendChild(section);
        return;
      }

      zoneData.forEach(g => {
        const div = document.createElement('div');
        div.className = `garaj ${g.occupied ? 'occupied' : 'available'}`;

        const occupantInfo = g.occupied ? `
          <div class="garaj-info">Nama: <span>${g.occupantName || 'Tidak diketahui'}</span></div>
          <div class="garaj-info">ID: <span>${g.occupantID || '-'}</span></div>
          <div class="garaj-info">Bulan Mula: <span>${g.occupantStartMonth || '-'}</span></div>
          <div class="garaj-info">Bulan Tamat: <span>${g.occupantEndMonth || '-'}</span></div>
          <div class="garaj-info">Tempoh: <span>${g.occupantDuration ? g.occupantDuration + ' bulan' : '-'}</span></div>
          <div class="garaj-info">Mesej: <span>${g.occupantMessage || '-'}</span></div>
        ` : '<div class="garaj-info empty">Tiada penyewa</div>';

        div.innerHTML = `
          <div class="garaj-label-row">
            <div class="garaj-label">${g.label}</div>
            <div class="garaj-status">${g.occupied ? 'Penuh' : 'Kosong'}</div>
          </div>
          <div class="garaj-body">
            ${occupantInfo}
          </div>
        `;
        grid.appendChild(div);
      });

      section.appendChild(grid);
      target.appendChild(section);
    }

    function exportCSV(){
        window.location.href = `${api}/export/csv`;
    }

</script>
</body>
</html>
