<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Dashboard - Garaj</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>User Dashboard - Tempahan Garaj</header>
<div class="container">

  <section class="hero">
    <div>
      <p class="eyebrow">Pilih garaj sendiri</p>
      <h1>Tempah serta-merta, garaj terus merah</h1>
      <p class="lede">Tekan zon untuk buka 22 garaj. Pilih lot hijau, isi maklumat, dan slot akan disahkan serta-merta dengan warna merah.</p>
    </div>
    <div class="hero-actions">
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </section>

  <div class="layout-grid">
    <div>
      <h3>Status Garaj</h3>
      <div class="garaj-container" id="garajContainer"></div>
    </div>
  </section>

    <div class="card form-card">
      <h3>Tempah Garaj</h3>
      <p class="eyebrow">Pilih lot terlebih dahulu</p>
      <div class="selected-garaj" id="selectedGarage">Tiada garaj dipilih</div>
      <div class="form-grid">
        <input type="text" id="name" placeholder="Nama">
        <input type="text" id="idNo" placeholder="No Matrik">
        <input type="month" id="startMonth">
        <select id="duration">
          <option value="1">1 Bulan</option>
          <option value="3">3 Bulan</option>
          <option value="6">6 Bulan</option>
          <option value="12">1 Tahun</option>
        </select>
      </div>
      <button class="book" onclick="bookGarage()">Tempah Sekarang</button>
    </div>
  </div>
</div>

<script>
const api = "https://admin-garaj-1.onrender.com";
const totalGaraj = 88;
const garajPerZone = 22;
const zones = ['A','B','C','D'];
let username = localStorage.getItem('username');
let latestStatus = [];
let selectedGarage = null;

function getGarageZone(garaj){
  if (garaj <= garajPerZone) return 'A';
  if (garaj <= garajPerZone * 2) return 'B';
  if (garaj <= garajPerZone * 3) return 'C';
  return 'D';
}

function formatGarageLabel(garaj){
  const zone = getGarageZone(garaj);
  const offset = garaj - ((zone.charCodeAt(0) - 65) * garajPerZone);
  return `${zone}${String(offset).padStart(2,'0')}`;
}

function groupGarajByZone(statusList){
  const parseGarajNumber = (g) => {
    if (g && Number.isFinite(g.garaj)) return g.garaj;
    if (g?.label && typeof g.label === 'string') {
      const match = g.label.match(/([A-D])(\d{1,2})/i);
      if (match) {
        const zoneLetter = match[1].toUpperCase();
        const offset = parseInt(match[2], 10);
        if (!isNaN(offset)) {
          return (zoneLetter.charCodeAt(0) - 65) * garajPerZone + offset;
        }
      }
    }
    return null;
  };

  const grouped = (Array.isArray(statusList) ? statusList : []).reduce((acc, g) => {
    const garajNumber = parseGarajNumber(g);
    if (!garajNumber) return acc;

    const zone = g.zone || getGarageZone(garajNumber);
    if (!zone) return acc;

    if (!acc[zone]) acc[zone] = [];
    acc[zone].push({ ...g, garaj: garajNumber, label: g.label || formatGarageLabel(garajNumber), zone });
    return acc;
  }, {});

  zones.forEach(zoneKey => {
    if (!grouped[zoneKey]) grouped[zoneKey] = [];
    grouped[zoneKey].sort((a, b) => a.garaj - b.garaj);
  });

  return grouped;
}

// Semak Autentikasi Pengguna
document.addEventListener('DOMContentLoaded', () => {
    const role = localStorage.getItem('role');
    if (!username || role !== 'user') {
        alert('Sila login untuk mengakses dashboard pengguna.');
        window.location.href = 'login.html';
    }
    fetchGarajStatus();
});

function logout() {
    localStorage.removeItem('username');
    localStorage.removeItem('role');
    localStorage.removeItem('studentID'); 
    window.location.href = 'login.html';
}

// ===== BUAT TEMPAHAN =====
async function bookGarage(){
  const studentName = document.getElementById('name').value;
  let studentID = document.getElementById('idNo').value || localStorage.getItem('studentID');
  const startMonth = document.getElementById('startMonth').value;
  const duration = document.getElementById('duration').value;

  if (!selectedGarage) return alert('Sila pilih garaj berwarna hijau dahulu.');
  if(!studentName || !studentID || !startMonth || !duration) return alert('Sila lengkapkan semua maklumat!');

  const res = await fetch(`${api}/bookings`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username,studentName,studentID,startMonth,duration,garaj:selectedGarage.garaj})
  });

  const data = await res.json();

  alert(data.message);

  if (res.ok) {
    selectedGarage = null;
    document.getElementById('selectedGarage').textContent = 'Tiada garaj dipilih';
    document.getElementById('startMonth').value = '';
  }

  fetchGarajStatus();
}

// ===== VISUAL STATUS GARAJ =====
async function fetchGarajStatus(){
  const res = await fetch(`${api}/garaj-status`);
  const status = await res.json();
  latestStatus = status;
  const container = document.getElementById('garajContainer');
  container.innerHTML='';

  const grouped = groupGarajByZone(status);
  let activeZone = container.dataset.activeZone || zones[0];
  if(!zones.includes(activeZone)) activeZone = zones[0];
  container.dataset.activeZone = activeZone;

  const zoneNav = document.createElement('div');
  zoneNav.className = 'zone-nav';

  zones.forEach(zone => {
    const btn = document.createElement('button');
    btn.className = `zone-pill ${activeZone === zone ? 'active' : ''}`;
    btn.textContent = `Zone ${zone}`;
    btn.onclick = () => {
      container.dataset.activeZone = zone;
      renderZone(zone, grouped, contentWrapper);
      [...zoneNav.children].forEach(child => child.classList.toggle('active', child.textContent === `Zone ${zone}`));
    };
    zoneNav.appendChild(btn);
  });

  const contentWrapper = document.createElement('div');
  renderZone(activeZone, grouped, contentWrapper);

  container.appendChild(zoneNav);
  container.appendChild(contentWrapper);
}

function renderZone(zone, grouped, target){
  const zoneData = grouped[zone] || [];
  target.innerHTML = '';

  const section = document.createElement('div');
  section.className = 'zone-section';

  const title = document.createElement('div');
  title.className = 'zone-header';
  const occupiedCount = zoneData.filter(g => g.occupied).length;
  const availableCount = garajPerZone - occupiedCount;
  title.innerHTML = `<div><p class="eyebrow">${occupiedCount} penuh Â· ${availableCount} kosong</p><h4>Zone ${zone} - ${garajPerZone} Garaj</h4></div>`;
  section.appendChild(title);

  const grid = document.createElement('div');
  grid.className = 'garaj-grid';

  if(zoneData.length === 0){
    const empty = document.createElement('div');
    empty.className = 'empty-zone';
    empty.textContent = 'Tiada data garaj untuk zon ini.';
    section.appendChild(empty);
    target.appendChild(section);
    return;
  }

  zoneData.forEach(g => {
    const div = document.createElement('div');
    const isSelected = selectedGarage && selectedGarage.garaj === g.garaj;
    div.className = `garaj ${g.occupied ? 'occupied' : 'available'} ${isSelected ? 'selected' : ''}`;

    const occupantInfo = g.occupied ? `
      <div class="garaj-info">Nama: <span>${g.occupantName || 'Tidak diketahui'}</span></div>
      <div class="garaj-info">ID: <span>${g.occupantID || '-'}</span></div>
      <div class="garaj-info">Bulan Mula: <span>${g.occupantStartMonth || '-'}</span></div>
      <div class="garaj-info">Bulan Tamat: <span>${g.occupantEndMonth || '-'}</span></div>
      <div class="garaj-info">Tempoh: <span>${g.occupantDuration ? g.occupantDuration + ' bulan' : '-'}</span></div>
      <div class="garaj-info">Mesej: <span>${g.occupantMessage || '-'}</span></div>
    ` : '<div class="garaj-info empty">Tiada penyewa</div>';

    div.innerHTML = `
      <div class="garaj-label-row">
        <div class="garaj-label">${g.label}</div>
        <div class="garaj-status">${g.occupied ? 'Penuh' : 'Kosong'}</div>
      </div>
      <div class="garaj-body">
        ${occupantInfo}
      </div>
    `;

    if (!g.occupied) {
      div.onclick = () => {
        selectedGarage = g;
        document.getElementById('selectedGarage').textContent = `Garaj dipilih: ${g.label} (Zone ${g.zone})`;
        renderZone(zone, grouped, target);
      };
    }
    grid.appendChild(div);
  });

  section.appendChild(grid);
  target.appendChild(section);
}
</script>
</body>
</html>
